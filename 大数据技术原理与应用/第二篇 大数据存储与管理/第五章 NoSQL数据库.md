# 第五章 NoSQL数据库
## 5.1 NoSQL简介
通常，NoSQL数据库具有以下几个特点：
1. 灵活的可拓展性
2. 灵活的数据模型
3. 与云计算紧密融合

## 5.2 NoSQL兴起的原因
### 5.2.1 关系数据库无法满足Web2.0的需求
1. 无法满足海量数据的管理需求
2. 无法满足数据高并发的需求
3. 无法满足高可拓展性和高可用性的需求

### 1. **问：MySQL集群是否可以完全解决问题？**
- 复杂性：部署、管理、配置很复杂
- 数据库复制：MySQL主备之间采用复制方式，只能是异步复制，当主库压力较大时可能产生较大延迟，主备切换可能丢失最后一部分更新事务，这时往往需要人工介入，备份和回复不方便
- 扩容问题：如果系统压力过大需要增加新的机器，这个过程涉及数据重新划分，整个过程复杂且容易出错
- 动态数据迁移问题：迁移过程需要总控节点整体协调以及数据库节点的配合，很难做到自动化。

![](https://i.postimg.cc/CL4hzs8m/5-2.png)

### 2.“One size fits all”模式不适合
关系模型作为统一的数据模型，既被用于数据分析，又被用于在线业务。而前者强调高吞吐，后者强调低延时，并不适合统一。  
而Hadoop针对数据分析，MongoDB、Redis等针对在线业务，抛弃了关系模型。

### 3. 关系数据库的关键特性成成为“鸡肋”
完善的“事务机制”和高效的查询机制是关系数据库的两大特性，但却成了“鸡肋”。
1. Web2.0网站系统通常不要求严格的数据库事务：实现事务保证数据库一致性需要大量的开销，而大量频繁实时读写是需要很大代价的
2. Web2.0并不要求严格的读写实时性：对于银行等机构，读写读写实时性很有必要，但是对于数据存储等并不是关键
3. Web2.0并不包含大量复杂的SQL查询：去结构化，存储空间换取更好的查询性能

## 5.3 NoSQL与关系数据库的比较
![](https://i.postimg.cc/dtJvPZfd/5-1-1.png)
![](https://i.postimg.cc/02Zv82g4/5-1-2.png)
![](https://i.postimg.cc/ZY8ZMxw4/5-1-3.png)
**总结**  
关系数据库:
1. 优势：以完善的关系代数理论为基础，有严格的标准，支持事务ACID，借助索引机制可以实现高效的查询，技术成熟
2. 劣势：可拓展性差，无法较好的支持海量数据的存储，数据模型过于死板、事务机制影响系统的性能

NoSQL数据库：
1. 优势：可以支持超大规模数据存储，灵活的数据模型可以很好的支持大规模数据应用，具有强大的横向扩展能力
2. 劣势：缺乏数学理论基础，复杂查询性能不高，不能实现事务强一致性，很难实现数据完整性，技术尚不成熟，维护困难等

- 关系数据库应用场景：电信、银行等领域的关键业务系统，需要保证强事务一致性
- NoSQL数据库应用场景：互联网企业、传统企业的非关键业务（如数据分析）
- 可以采用混合架构来具体实施

## 5.4 NoSQL的四大类型
归结起来，典型的NoSQL数据库通常包括键值数据库、列族数据库、文档数据库和图形数据库。
![](https://i.postimg.cc/NjwJFZTr/5-1-1.png)
![](https://i.postimg.cc/KYG0rL0G/5-1-2.png)
### 5.4.1 键值数据库
键值数据库（Key-Value Database）使用一个哈希表，这个表有一个特定的Key和一个指针指向特定的Value，Key用来定位Value，即存储和检索具体的Value，Value对数据库不可见，不能对Value进行索引和查询。

在大量读写情况下，键值数据库性能更好，因为关系数据需要频繁更新索引。键值数据库分为内存键值数据库（Memcached、Redis）和持久化键值数据库（BerkeleyDB、Voldmort）。

同时，键值数据库也有缺点，条件查询就是键值数据库的弱项，如果只对部分值进行查询或更新，效率会比较低下，应尽量避免多表关联查询，可以采用双向冗余存储关系来代替表关联把操作分解成单表操作。此外，键值数据库不支持回滚操作，也就无法支持事务。

![](https://i.postimg.cc/BnB0nT84/5-2.png)
![](https://i.postimg.cc/bv6fQqH5/5-4-1.png)

### 5.4.2 列族数据库
数据库由多个行构成，每行数据包括多个列族、不同的行可以具有不同数量的列族，属于同一列族的数据会被存放在一起。
![](https://i.postimg.cc/FRrrbPLP/5-3.png)

### 5.4。3 文档数据库
文档数据库通过键来定位一个文档，是键值的衍生品。文档可以是非常复杂的数据结构，如嵌套对象等。可以通过Key构建索引，也可以基于文档内容来构建索引（键值不行），所以查询效率更高。文档数据库主要用于存储并检索文档数据。
![](https://i.postimg.cc/1X4y2fMw/5-4.png)

### 5.4.4 图数据库
图数据库使用图作为数据模型来存储数据，可以高效地存储不同顶点之间的关系。图数据库专门用于处理具有高度相互关联的数据，可以高效处理实体之间的关系，适合社交网络、模式识别等。
![](https://i.postimg.cc/gkXYKLxP/5-5.png)

### 5.4.5 不同类型数据库的对比
- MySQL产生较早，是互联网使用最多的数据库
- MongoDB是个新生事物，提供更灵活的数据模型、异步提交、地理位置索引等五花十色的功能
- HBase依赖于Hadoop生态，具有很好的扩展性
- Redis是键值存储的代表，功能简单，提供随机数据存储，伸缩性特别好。

## 5.5 NoSQL的三大基石
![](https://i.postimg.cc/mDg41tvJ/image.png)
### 5.5.1 CAP
- C：Consistency，一致性。所有节点在同一时间具有相同的数据。
- A：Availability，可用性。可以在确定的时间内返回操作结果。
- P：Tolerance of Network Partition：分区容忍性。系统中任意信息的丢失或失败不会影响系统继续运作。

![](https://i.postimg.cc/T2Sxh2CN/CAP.png)
CAP理论：一个分布式系统，不可能同时满足一致性、可用性和分区容忍性，最多同时满足其中两个。（如果追求一致性、则放弃可用性，需要处理失败操作；如果追求可用性，则可能不一致）

例子：
![](https://i.postimg.cc/nhKfd4ZN/5-3-1.png)
![](https://i.postimg.cc/xd0DBX18/5-3-2.png)
![](https://i.postimg.cc/mr8f4TPw/5-3-3.png)

1. CA：强调一致性，可用性，放弃分区容忍性，缺乏可扩展性，如MySQl，SQL Server
2. CP：强调一致性，分区容忍性，放弃可用性，出现问题时无法提供服务，如Neo4J，BigTable
3. AP：强调可用性，分区容忍性，放弃一致性，数据版本会不一致。
![](https://i.postimg.cc/0NWkfY0P/5-5.png)

### 5.5.2 BASE
![](https://i.postimg.cc/YqKpbqYG/5-5-2.png)

BASE（Basically Available基本可用，Soft-state软状态，Eventually consistency最终一致）

1. 基本可用：允许分区失败的情况，如10个节点中1个损坏，其他9个节点仍然正常，那么就是基本可用
2. 软状态：与“硬状态”（数据时刻保持一致）相对应，软状态允许数据在某个时间内不同步，具有滞后性，如A给B转账，A扣10元，过了一定延迟后B才加10元
3. 最终一致性：强一致性要求保证读到更新后的数据，而最终一致性属于弱一致性，允许暂时读不到，但最终必须读到。如DNS系统，带有过期机制缓存，最终所有客户端都是最新。

### 5.5.3 最终一致性
- 因果一致性：如果进程A通知进程B它已经更新了一个数据，那么进程B的后续访问将得到最新值，而无关的进程C满足最终一致性即可。
- 读己之所写：如果进程A自己执行一个更新，那么他总能读到最新值
- 会话一致性：它会把访问存储系统的进程放到会话（Session）中，只要会话存在，则保证“读己之所写”一致性，如果建立新会话，则不会成立
- 单调读一致性：如果进程已经看过某个数据，则后续访问不会读取更老的值
- 单调写一致性：系统保证来自同一个进程的写操作顺序执行。

## 如何实现各种类型的一致性？
看读的节点和写的节点是否有重合。N-W是数据不是最新的节点的数量，R>N-W则表示读的节点和写的节点有重合（能读到最新数据）
![](https://i.postimg.cc/7ZXGFTnQ/5.png)

### 5.6 从NoSQl到NewSQL
![](https://i.postimg.cc/zX2Y4zRF/5-6.png)
![](https://i.postimg.cc/sX4tmsrS/5-7.png)
